# Интеграция с Mistral AI

## Обзор

Этот документ описывает принципы работы с Mistral AI API в проекте. Интеграция обеспечивает:

1. Безопасное хранение API ключа
2. Контроль частоты запросов (RPS) для соблюдения ограничений API
3. Использование официального SDK для взаимодействия с API
4. Обработку ошибок и резервные механизмы
5. Паттерн синглтон для оптимизации работы с API

## Компоненты интеграции

### 1. MessageHandler (синглтон)

`MessageHandler` отвечает за обработку сообщений пользователя и извлечение сущностей. 
Реализован как синглтон, чтобы избежать создания множества экземпляров при обработке сообщений.

История сообщений используется только для извлечения контекста диалога:
```python
def process_message(self, input_text: str, message_history: List[RedisMessage]) -> ScheduleResponse | MessageResponse:
    # Извлекаем текущие сущности из истории сообщений
    current_entities = self._parse_message_history(message_history)
    
    # Извлекаем новые сущности из входного сообщения
    updated_entities = self.entity_extractor.extract_entities(input_text, current_entities)
```

### 2. MistralAIClient

Отвечает за взаимодействие с API Mistral. Использует официальный SDK Mistral AI, с резервным вариантом через REST API.

Приоритет использования API:
1. Официальный SDK (в большинстве случаев)
2. REST API (если SDK не доступен)

### 3. RateLimiter

Контролирует частоту запросов к API, учитывая ограничения сервиса на количество запросов в секунду (RPS).

```python
MAX_RPS: float = float(os.getenv("MISTRAL_MAX_RPS", "1.0"))  # Максимум запросов в секунду
```

## API ключ

API ключ Mistral AI хранится в переменной окружения `MISTRAL_API_KEY`. Если она не задана, используется значение по умолчанию из конфигурационного файла.

```python
API_KEY: str = os.getenv("MISTRAL_API_KEY", "upWAez8N7HBDMnFAR3JmTcqmxlQzz3Ll")
```

## Ограничения RPS (запросов в секунду)

Mistral API имеет ограничения на количество запросов в единицу времени. Для контроля соблюдения этих ограничений реализован механизм с использованием алгоритма "токенного ведра" (token bucket).

Класс `RateLimiter` обеспечивает контроль частоты запросов:
- Каждый запрос "забирает" один токен из ведра
- Токены постепенно восполняются со скоростью, определенной в MAX_RPS
- Если токенов недостаточно, вызов блокируется до восполнения нужного количества

## Обработка ошибок

Система обрабатывает различные типы ошибок:

1. Ошибки SDK Mistral (MistralException)
2. Ошибки 429 (превышение лимитов) - автоматическое ожидание и повторные попытки
3. Ошибки парсинга JSON из ответа API
4. Общие ошибки соединения

## Установка зависимостей

Для работы с Mistral API необходимо установить зависимости:

```bash
pip install -r requirements.txt
```

## Конфигурация

Настройки Mistral AI можно изменить через переменные окружения:

- `MISTRAL_API_KEY` - API ключ Mistral AI
- `MISTRAL_API_URL` - URL API Mistral AI
- `MISTRAL_MODEL_NAME` - Название модели Mistral AI
- `MISTRAL_TEMPERATURE` - Температура генерации
- `MISTRAL_MAX_TOKENS` - Максимальное количество токенов ответа
- `MISTRAL_MAX_RPS` - Максимальное количество запросов в секунду
- `MISTRAL_THROTTLE_TIME` - Время задержки при превышении RPS 